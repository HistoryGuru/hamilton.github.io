<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hamilton – Intelligent Debate Speech Generator</title>

<script src="https://js.puter.com/v2/"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
[contenteditable]:empty:before {
    content: attr(data-placeholder);
    color: #94a3b8;
    font-style: italic;
}

/* Debate Card Styling */
.debate-card {
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    color: #1e293b;
}

.debate-card .tag {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 0.5em;
    display: block;
}

.debate-card .cite {
    font-size: 0.95em;
    margin-bottom: 0.3em;
}

.debate-card .author {
    font-weight: normal;
}

.debate-card .year {
    font-weight: normal;
}

.debate-card mark {
    background-color: #7dd3fc;
    color: black;
    padding: 0;
}

.debate-card u {
    text-decoration: underline;
}

.debate-card strong {
    font-weight: bold;
}

.debate-card .card-text {
    margin-top: 0.5em;
}

.debate-card .shrunk {
    font-size: 0.75em;
    line-height: 1.3;
    color: #64748b;
}

/* Modal Overlay */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-content {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 16px;
    padding: 32px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 2px solid #fbbf24;
}

.plan-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid #475569;
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s;
}

.plan-card:hover {
    border-color: #fbbf24;
    transform: translateY(-4px);
}

.plan-card.selected {
    border-color: #fbbf24;
    background: rgba(251, 191, 36, 0.1);
}
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6">
<div class="max-w-6xl mx-auto pb-16">

<header class="text-center mb-8">
    <h1 class="text-5xl font-bold text-amber-400">Hamilton</h1>
    <p class="text-slate-300">Intelligent Debate Speech Generator</p>
    <p class="text-slate-400 text-sm mt-2" id="planIndicator">Loading...</p>
</header>

<!-- Tabs -->
<div class="flex gap-4 mb-6 justify-center">
    <button id="counterTab" class="px-6 py-3 rounded bg-slate-800 text-slate-300">
        Counter-Speech Generator
    </button>
    <button id="caseTab" class="px-6 py-3 rounded bg-amber-500 text-slate-900 font-semibold">
        Write Me a Case
    </button>
</div>

<!-- COUNTER SPEECH -->
<div id="counterSection" class="hidden">
<div class="grid md:grid-cols-2 gap-6">

<!-- INPUT -->
<div class="bg-slate-800/50 p-6 rounded border border-slate-700">
    <h2 class="text-xl font-semibold text-amber-400 mb-3">Case Input</h2>

    <div id="caseInput" contenteditable
        class="bg-slate-900 h-64 p-4 rounded border border-slate-600 text-slate-100 overflow-y-auto"
        data-placeholder="Paste your formatted debate case here...">
    </div>

    <label class="block text-slate-300 mt-4">
        Speech Length: <span id="speechLengthDisplay">3</span> minutes
    </label>
    <input id="speechLength" type="range" min="1" max="8" value="3" class="w-full">

    <button id="generateCounterBtn"
        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-3 rounded">
        Generate Counter-Speech
    </button>
    
    <p id="counterUsageInfo" class="text-slate-400 text-sm mt-2 text-center"></p>
</div>

<!-- OUTPUT -->
<div class="bg-slate-800/50 p-6 rounded border border-slate-700">
    <h2 class="text-xl font-semibold text-amber-400 mb-3">Counter-Speech</h2>
    <div class="bg-slate-900 p-4 h-96 rounded overflow-y-auto border border-slate-600">
        <p id="counterOutput" class="text-slate-400 italic">
            Your generated counter-speech will appear here…
        </p>
    </div>
</div>

</div>
</div>

<!-- CASE WRITER -->
<div id="caseSection">
<div class="grid md:grid-cols-2 gap-6">

<div class="bg-slate-800/50 p-6 rounded border border-slate-700">
    <input id="topic"
        class="w-full p-3 bg-slate-900 border border-slate-600 rounded text-slate-100"
        placeholder="Topic / Resolution">

    <div class="flex gap-2 mt-3">
        <button id="affBtn" class="flex-1 bg-amber-500 py-2 rounded font-semibold text-slate-900">
            Affirmative
        </button>
        <button id="negBtn" class="flex-1 bg-slate-700 py-2 rounded text-slate-300">
            Negative
        </button>
    </div>

    <input id="focusPoint1"
        class="w-full mt-3 p-3 bg-slate-900 border border-slate-600 rounded text-slate-100"
        placeholder="Focus Point 1 (Required)">

    <div class="flex items-center gap-2 mt-2">
        <label class="text-slate-300 text-sm">Cards:</label>
        <input id="cardsPerPoint1" type="number" min="1" max="5" value="2"
            class="w-16 p-1 bg-slate-900 border border-slate-600 rounded text-slate-100 text-center">
    </div>

    <input id="focusPoint2"
        class="w-full mt-3 p-3 bg-slate-900 border border-slate-600 rounded text-slate-100"
        placeholder="Focus Point 2 (Optional)">

    <div class="flex items-center gap-2 mt-2">
        <label class="text-slate-300 text-sm">Cards:</label>
        <input id="cardsPerPoint2" type="number" min="1" max="5" value="2"
            class="w-16 p-1 bg-slate-900 border border-slate-600 rounded text-slate-100 text-center">
    </div>

    <button id="generateCaseBtn"
        class="w-full mt-4 bg-amber-500 hover:bg-amber-600 py-3 rounded font-semibold text-slate-900">
        Generate Case
    </button>
    
    <p id="caseUsageInfo" class="text-slate-400 text-sm mt-2 text-center"></p>
</div>

<div class="bg-slate-800/50 p-6 rounded border border-slate-700">
    <h2 class="text-xl font-semibold text-amber-400 mb-3">Generated Case</h2>
    <div class="bg-white p-4 h-96 rounded overflow-y-auto border border-slate-600">
        <div id="caseOutput" class="text-slate-500 italic">
            Your generated case will appear here…
        </div>
    </div>
</div>

</div>
</div>

</div>

<!-- Upgrade Modal -->
<div id="upgradeModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-md">
        <h2 class="text-2xl font-bold text-amber-400 text-center mb-4">Upgrade Required</h2>
        <p class="text-slate-300 text-center mb-6" id="upgradeMessage"></p>
        <button class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-3 rounded mb-3" onclick="showPaywall()">
            View Plans & Upgrade
        </button>
        <button class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded" onclick="closeUpgradeModal()">
            Cancel
        </button>
    </div>
</div>

<!-- Footer -->
<footer class="fixed bottom-0 left-0 right-0 bg-slate-900/90 border-t border-slate-700 py-2 text-center">
    <p class="text-slate-400 text-sm">All Code by Leroy Qu</p>
</footer>

<script type="module">
import { checkJuniorVarsityStatus, checkVarsityStatus, showSubscriptionPaywall } from "./revenuecat.js";

// User plan and usage tracking
let userPlan = {
    type: 'novice', // 'novice', 'jv', 'varsity'
    caseUsageToday: 0,
    counterUsageToday: 0,
    lastResetDate: new Date().toDateString()
};

// Initialize app and check subscription status
async function initApp() {
    try {
        // Check subscription tiers
        const isVarsity = await checkVarsityStatus();
        const isJV = await checkJuniorVarsityStatus();
        
        if (isVarsity) {
            userPlan.type = 'varsity';
            document.getElementById('planIndicator').textContent = 'Varsity Plan ($9.99/mo)';
        } else if (isJV) {
            userPlan.type = 'jv';
            document.getElementById('planIndicator').textContent = 'JV Plan ($5.99/mo)';
        } else {
            userPlan.type = 'novice';
            document.getElementById('planIndicator').textContent = 'Novice Plan (Free)';
        }
        
        // Load usage from localStorage
        loadUsageData();
        updateUI();
    } catch (error) {
        console.error('Error checking subscription status:', error);
        userPlan.type = 'novice';
        document.getElementById('planIndicator').textContent = 'Novice Plan (Free)';
        updateUI();
    }
}

// Load usage data from localStorage
function loadUsageData() {
    const stored = localStorage.getItem('hamiltonUsage');
    if (stored) {
        const savedUsage = JSON.parse(stored);
        // Reset if it's a new day
        if (savedUsage.lastResetDate !== new Date().toDateString()) {
            userPlan.caseUsageToday = 0;
            userPlan.counterUsageToday = 0;
            userPlan.lastResetDate = new Date().toDateString();
        } else {
            userPlan.caseUsageToday = savedUsage.caseUsageToday || 0;
            userPlan.counterUsageToday = savedUsage.counterUsageToday || 0;
            userPlan.lastResetDate = savedUsage.lastResetDate;
        }
    }
    saveUsageData();
}

function saveUsageData() {
    localStorage.setItem('hamiltonUsage', JSON.stringify({
        caseUsageToday: userPlan.caseUsageToday,
        counterUsageToday: userPlan.counterUsageToday,
        lastResetDate: userPlan.lastResetDate
    }));
    updateUI();
}

function updateUI() {
    const limits = getPlanLimits();
    
    // Update usage info
    if (limits.casesPerDay === Infinity) {
        document.getElementById('caseUsageInfo').textContent = `Cases used today: ${userPlan.caseUsageToday}`;
    } else {
        document.getElementById('caseUsageInfo').textContent = `Cases used: ${userPlan.caseUsageToday}/${limits.casesPerDay} today`;
    }
    
    if (limits.counterPerDay === Infinity) {
        document.getElementById('counterUsageInfo').textContent = `Counter-speeches used today: ${userPlan.counterUsageToday}`;
    } else {
        document.getElementById('counterUsageInfo').textContent = `Counter-speeches used: ${userPlan.counterUsageToday}/${limits.counterPerDay} today`;
    }
    
    // Update card input limits
    document.getElementById('cardsPerPoint1').max = limits.maxCards;
    document.getElementById('cardsPerPoint2').max = limits.maxCards;
}

function getPlanLimits() {
    const limits = {
        'novice': { casesPerDay: 2, counterPerDay: 3, maxCards: 2 },
        'jv': { casesPerDay: 5, counterPerDay: Infinity, maxCards: 4 },
        'varsity': { casesPerDay: Infinity, counterPerDay: Infinity, maxCards: 5 }
    };
    return limits[userPlan.type] || limits.novice;
}

// Make showPaywall available globally
window.showPaywall = function() {
    showSubscriptionPaywall();
};

function showUpgradeModal(message) {
    document.getElementById('upgradeMessage').textContent = message;
    document.getElementById('upgradeModal').style.display = 'flex';
}

window.closeUpgradeModal = function() {
    document.getElementById('upgradeModal').style.display = 'none';
};

function checkCardLimit() {
    const limits = getPlanLimits();
    const cards1 = parseInt(document.getElementById('cardsPerPoint1').value) || 0;
    const cards2 = parseInt(document.getElementById('cardsPerPoint2').value) || 0;
    
    if (cards1 > limits.maxCards || cards2 > limits.maxCards) {
        showUpgradeModal(`Your plan allows a maximum of ${limits.maxCards} cards per focus point. Upgrade to Varsity for up to 5 cards!`);
        return false;
    }
    return true;
}

/* =========================================================
   CENTRALIZED AI CALL (PUTER AI)
   ========================================================= */
async function callAI(system, user, maxTokens = 1200) {
    try {
        const response = await puter.ai.chat([
            { role: "system", content: system },
            { role: "user", content: user }
        ], {
            model: "claude-sonnet-4-20250514",
            temperature: 0.7,
            max_tokens: maxTokens
        });

        console.log("Puter AI Response:", response);

        if (response.message && response.message.content) {
            if (Array.isArray(response.message.content)) {
                return response.message.content
                    .filter(block => block.type === 'text')
                    .map(block => block.text)
                    .join('\n');
            }
            return response.message.content;
        }
        
        if (typeof response === 'string') {
            return response;
        } else if (response.text) {
            return response.text;
        } else if (response.content) {
            return response.content;
        }
        
        return JSON.stringify(response, null, 2);
    } catch (error) {
        console.error("AI Error:", error);
        throw new Error("AI request failed: " + error.message);
    }
}

/* =========================================================
   TAB LOGIC
   ========================================================= */
document.getElementById('counterTab').onclick = () => {
    document.getElementById('counterSection').classList.remove("hidden");
    document.getElementById('caseSection').classList.add("hidden");
    document.getElementById('counterTab').className = "px-6 py-3 rounded bg-amber-500 text-slate-900 font-semibold";
    document.getElementById('caseTab').className = "px-6 py-3 rounded bg-slate-800 text-slate-300";
};
document.getElementById('caseTab').onclick = () => {
    document.getElementById('caseSection').classList.remove("hidden");
    document.getElementById('counterSection').classList.add("hidden");
    document.getElementById('caseTab').className = "px-6 py-3 rounded bg-amber-500 text-slate-900 font-semibold";
    document.getElementById('counterTab').className = "px-6 py-3 rounded bg-slate-800 text-slate-300";
};

/* =========================================================
   COUNTER SPEECH
   ========================================================= */
document.getElementById('speechLength').oninput = e =>
    document.getElementById('speechLengthDisplay').textContent = e.target.value;

document.getElementById('generateCounterBtn').onclick = async () => {
    // Check usage limits
    const limits = getPlanLimits();
    if (userPlan.counterUsageToday >= limits.counterPerDay) {
        showUpgradeModal(`You've reached your daily limit of ${limits.counterPerDay} counter-speeches. Upgrade for more!`);
        return;
    }
    
    const counterOutput = document.getElementById('counterOutput');
    const caseInput = document.getElementById('caseInput');
    const speechLength = document.getElementById('speechLength');
    
    counterOutput.textContent = "Generating…";

    const prompt = `
Generate a ${speechLength.value}-minute rebuttal speech
against the following case:

${caseInput.innerText}

Be structured, analytical, and persuasive.
    `;

    try {
        const text = await callAI(
            "You are a high-level debate coach.",
            prompt,
            speechLength.value * 180
        );
        counterOutput.innerText = text;
        userPlan.counterUsageToday++;
        saveUsageData();
    } catch (err) {
        counterOutput.innerText = err.message;
    }
};

/* =========================================================
   CASE GENERATOR
   ========================================================= */
let side = "Aff";
document.getElementById('affBtn').onclick = () => {
    side = "Aff";
    document.getElementById('affBtn').className = "flex-1 bg-amber-500 py-2 rounded font-semibold text-slate-900";
    document.getElementById('negBtn').className = "flex-1 bg-slate-700 py-2 rounded text-slate-300";
};
document.getElementById('negBtn').onclick = () => {
    side = "Neg";
    document.getElementById('negBtn').className = "flex-1 bg-amber-500 py-2 rounded font-semibold text-slate-900";
    document.getElementById('affBtn').className = "flex-1 bg-slate-700 py-2 rounded text-slate-300";
};

document.getElementById('generateCaseBtn').onclick = async () => {
    // Check card limits
    if (!checkCardLimit()) {
        return;
    }
    
    // Check usage limits
    const limits = getPlanLimits();
    if (userPlan.caseUsageToday >= limits.casesPerDay) {
        showUpgradeModal(`You've reached your daily limit of ${limits.casesPerDay} cases. Upgrade for more!`);
        return;
    }
    
    const caseOutput = document.getElementById('caseOutput');
    const topic = document.getElementById('topic');
    const focusPoint1 = document.getElementById('focusPoint1');
    const focusPoint2 = document.getElementById('focusPoint2');
    const cardsPerPoint1 = document.getElementById('cardsPerPoint1');
    const cardsPerPoint2 = document.getElementById('cardsPerPoint2');
    
    caseOutput.innerHTML = "<p class='text-slate-500 italic'>Generating your debate case...</p>";

    const focusPoints = [];
    if (focusPoint1.value) {
        focusPoints.push({
            point: focusPoint1.value,
            cards: parseInt(cardsPerPoint1.value) || 2
        });
    }
    if (focusPoint2.value) {
        focusPoints.push({
            point: focusPoint2.value,
            cards: parseInt(cardsPerPoint2.value) || 2
        });
    }

    const prompt = `You are an expert debate case writer. Write a complete ${side} debate case on: "${topic.value}"

CRITICAL FORMATTING REQUIREMENTS:

For each contention/focus point, create ${focusPoints[0]?.cards || 2} evidence cards in this EXACT format:

<div class="debate-card">
<span class="tag"><strong>[Compelling Tag Line]</strong></span>
<p class="cite"><span class="author">Author</span> '<span class="year">YY</span> <span class="qualification">[Full credentials, title, institution, date, publication/source]</span></p>
<div class="card-text">
<span class="shrunk">[Less important context text in smaller font] </span><mark><u><strong>the most crucial points are highlighted</strong></u></mark><span class="shrunk"> [more context] </span><mark><u>and key evidence is marked</u></mark><span class="shrunk"> [concluding context]</span>. <mark><u><strong>The highlighted text must flow smoothly</strong></u></mark><span class="shrunk"> and form complete arguments when read alone.</span>
</div>
</div>

REQUIREMENTS:
1. Use <strong> for bold, <u> for underline, <mark> for highlighting
2. Apply <span class="shrunk"> to less important text
3. Highlight ONLY the most important phrases that flow together
4. Format citation as: Author 'YY [full qualifications]
5. Include full article context but shrink unimportant parts
6. Highlighted portions should read smoothly on their own
7. Use all three formatting types (bold, underline, highlight) strategically

Focus Points:
${focusPoints.map((fp, i) => `${i+1}. ${fp.point} (${fp.cards} cards)`).join('\n')}

Generate the complete case with proper HTML formatting.`;

    try {
        const text = await callAI(
            "You are an expert debate case writer who formats evidence cards in proper debate style with highlighting, underlining, and strategic text sizing.",
            prompt,
            3000
        );
        caseOutput.innerHTML = text;
        userPlan.caseUsageToday++;
        saveUsageData();
    } catch (err) {
        caseOutput.innerHTML = `<p class="text-red-500">${err.message}</p>`;
    }
};

// Check card inputs when they change
document.getElementById('cardsPerPoint1').onchange = checkCardLimit;
document.getElementById('cardsPerPoint2').onchange = checkCardLimit;
</script>

</body>
</html>
