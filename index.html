import React, { useState, useRef } from 'react';
import { Volume2, Copy, Download, FileText } from 'lucide-react';

const HamiltonDebate = () => {
  const [activeTab, setActiveTab] = useState('counter');
  const [speechLength, setSpeechLength] = useState(3);
  const [generatedSpeech, setGeneratedSpeech] = useState('');
  const [loading, setLoading] = useState(false);
  const [parsedArgs, setParsedArgs] = useState([]);
  const contentEditableRef = useRef(null);
  
  const [topic, setTopic] = useState('');
  const [side, setSide] = useState('Aff');
  const [focusPoint1, setFocusPoint1] = useState('');
  const [focusPoint2, setFocusPoint2] = useState('');
  const [evidencePerPoint, setEvidencePerPoint] = useState(3);
  const [generatedCase, setGeneratedCase] = useState('');
  const [caseLoading, setCaseLoading] = useState(false);

  const generateCase = async () => {
    setCaseLoading(true);
    setGeneratedCase('');

    const focusPoints = [focusPoint1, focusPoint2].filter(fp => fp.trim());
    
    if (!topic.trim() || focusPoints.length === 0) {
      setGeneratedCase("Please provide a topic and at least one focus point.");
      setCaseLoading(false);
      return;
    }

    try {
      const prompt = `You are an expert debate case writer. Generate a complete ${side} case for the topic: "${topic}".

Focus points to cover: ${focusPoints.join(', ')}

For EACH focus point, create ${evidencePerPoint} pieces of evidence. Each piece of evidence should follow this structure:

1. CLAIM: A clear argument statement (1 per focus point that ties all evidence together)
2. TAG: A concise summary of what the evidence proves (this should be bolded)
3. CITATION: Realistic author and year (format: AuthorLastName 'YY) 
4. EVIDENCE: Full paragraph of evidence (150-250 words) that includes:
   - Background context
   - Key data, statistics, or expert analysis
   - LINK: Explanation of the causal mechanism (how/why the claim happens)
   - IMPACT: The consequence or outcome (what happens as a result)

CRITICAL FORMATTING INSTRUCTIONS:
- Write each piece of evidence as a complete, realistic academic paragraph
- Use HTML formatting: <strong> for tags and author citations, <mark> for 2-4 key sentences that contain the most important warrants/impacts
- The marked sections should highlight the crucial link and impact portions
- Make the evidence sound like real academic writing with proper sourcing style
- Ensure logical flow: Claim → Evidence → Link → Impact

Example format for ONE piece of evidence:

<strong>[TAG SUMMARIZING THE POINT]</strong>
<strong>AuthorLastName 'YY</strong>
Full paragraph of evidence here with context and background. <mark>This sentence contains the key link explaining the causal mechanism.</mark> Additional supporting details and analysis. <mark>This sentence delivers the critical impact showing why this matters.</mark> Concluding context that ties it together.

Generate the full ${side} case now with ${evidencePerPoint} pieces of evidence per focus point.`;

      const response = await fetch('https://api.puter.com/drivers/call', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          interface: 'puter-chat-completion',
          driver: 'openai-completion',
          method: 'complete',
          args: {
            messages: [
              {
                role: 'system',
                content: 'You are an expert debate case writer who creates well-researched, properly formatted debate evidence with realistic citations and academic writing style.'
              },
              {
                role: 'user',
                content: prompt
              }
            ]
          }
        })
      });

      const data = await response.json();
      const caseText = data.message?.content || 'Error generating case';
      setGeneratedCase(caseText);
    } catch (error) {
      setGeneratedCase('Error connecting to Puter AI. Please check your connection and try again.\n\nError: ' + error.message);
    }
    
    setCaseLoading(false);
  };

  const copyCase = () => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = generatedCase;
    
    const range = document.createRange();
    range.selectNodeContents(tempDiv);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    document.body.appendChild(tempDiv);
    document.execCommand('copy');
    document.body.removeChild(tempDiv);
    selection.removeAllRanges();
  };

  const downloadCase = () => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = generatedCase;
    const text = tempDiv.innerText;
    
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'debate-case.txt';
    a.click();
  };

  const parseRichTextCase = (htmlContent) => {
    const args = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');
    const body = doc.body;

    const highlightedElements = [];
    const walker = document.createTreeWalker(
      body,
      NodeFilter.SHOW_ELEMENT,
      null,
      false
    );

    let node;
    while ((node = walker.nextNode())) {
      const bgColor = node.style.backgroundColor;
      
      const hasBackground = bgColor && 
        bgColor !== 'transparent' && 
        bgColor !== 'rgba(0, 0, 0, 0)' &&
        bgColor !== 'rgb(255, 255, 255)' &&
        bgColor !== '#ffffff' &&
        bgColor !== 'white';
      
      const isHighlighted = 
        node.tagName === 'MARK' ||
        node.tagName === 'EM' ||
        hasBackground ||
        node.style.textDecoration?.includes('underline');

      if (isHighlighted) {
        const text = node.textContent.trim();
        if (text.length > 10) {
          highlightedElements.push(text);
        }
      }
    }

    const fullText = body.textContent;
    const lines = fullText.split('\n').map(l => l.trim()).filter(l => l);

    let currentArg = null;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      const authorMatch = line.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+[''](\d{2}|\d{4})/);
      if (authorMatch) {
        if (currentArg && currentArg.highlights.length > 0) {
          args.push(currentArg);
        }
        currentArg = {
          author: authorMatch[0],
          tag: '',
          highlights: []
        };
        continue;
      }

      if (currentArg && !currentArg.tag) {
        const tagMatch = line.match(/^\[([^\]]+)\]/) || line.match(/^([A-Z\s]{5,}[A-Z])$/);
        if (tagMatch) {
          currentArg.tag = tagMatch[1] || tagMatch[0];
          continue;
        }
      }
    }

    if (highlightedElements.length > 0) {
      if (currentArg) {
        currentArg.highlights = highlightedElements;
        args.push(currentArg);
      } else {
        const authorMatch = fullText.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+[''](\d{2}|\d{4})/);
        args.push({
          author: authorMatch ? authorMatch[0] : 'Source citation',
          tag: lines[0]?.substring(0, 100) || 'Main argument',
          highlights: highlightedElements
        });
      }
    }

    return args;
  };

  const generateCounterSpeech = async () => {
    setLoading(true);
    const htmlContent = contentEditableRef.current.innerHTML;
    const parsed = parseRichTextCase(htmlContent);
    setParsedArgs(parsed);

    if (parsed.length === 0) {
      setGeneratedSpeech("No arguments detected. Please ensure your case includes:\n- Author citations (e.g., Smith '23)\n- Bolded tags\n- Highlighted evidence (use your word processor's highlight tool, then copy/paste)");
      setLoading(false);
      return;
    }

    try {
      const prompt = `You are a skilled debate coach. Generate a ${speechLength}-minute rebuttal speech against the following arguments. Be direct, analytical, and persuasive. Structure your speech with clear transitions.

Arguments to refute:
${parsed.map((arg, i) => `
${i + 1}. ${arg.tag || 'Argument'}
Source: ${arg.author}
Key claims: ${arg.highlights.join(' ... ')}
`).join('\n')}

Generate a flowing ${speechLength}-minute speech that:
1. Briefly signposts the main refutations
2. Systematically addresses each argument with specific counterarguments
3. Points out logical flaws, questionable evidence, or alternative interpretations
4. Uses clear transitions between points
5. Concludes with impact analysis

Format as a natural speech, not bullet points. Target approximately ${speechLength * 150} words.`;

      const response = await fetch('https://api.puter.com/drivers/call', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          interface: 'puter-chat-completion',
          driver: 'openai-completion',
          method: 'complete',
          args: {
            messages: [
              {
                role: 'system',
                content: 'You are a skilled debate coach who creates persuasive counter-arguments.'
              },
              {
                role: 'user',
                content: prompt
              }
            ]
          }
        })
      });

      const data = await response.json();
      const speech = data.message?.content || 'Error generating speech';
      setGeneratedSpeech(speech);
    } catch (error) {
      setGeneratedSpeech('Error connecting to Puter AI. Please check your connection and try again.\n\nError: ' + error.message);
    }
    
    setLoading(false);
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(generatedSpeech);
  };

  const downloadSpeech = () => {
    const blob = new Blob([generatedSpeech], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'hamilton-speech.txt';
    a.click();
  };

  const handlePaste = (e) => {
    e.preventDefault();
    const html = e.clipboardData.getData('text/html');
    const text = e.clipboardData.getData('text/plain');
    
    if (html) {
      document.execCommand('insertHTML', false, html);
    } else {
      document.execCommand('insertText', false, text);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6">
      <div className="max-w-6xl mx-auto">
        <header className="text-center mb-8">
          <h1 className="text-5xl font-bold text-amber-400 mb-2">
            Hamilton
          </h1>
          <p className="text-slate-300 text-lg">
            Intelligent Debate Speech Generator
          </p>
        </header>

        <div className="flex gap-4 mb-6 justify-center">
          <button
            onClick={() => setActiveTab('counter')}
            className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
              activeTab === 'counter'
                ? 'bg-amber-500 text-slate-900'
                : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
            }`}
          >
            Counter-Speech Generator
          </button>
          <button
            onClick={() => setActiveTab('case')}
            className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
              activeTab === 'case'
                ? 'bg-amber-500 text-slate-900'
                : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
            }`}
          >
            Write Me a Case
          </button>
        </div>

        {activeTab === 'counter' ? (
          <div>
            <div className="grid md:grid-cols-2 gap-6">
              <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
                <h2 className="text-2xl font-semibold text-amber-400 mb-4">
                  Case Input
                </h2>
                
                <div
                  ref={contentEditableRef}
                  contentEditable
                  onPaste={handlePaste}
                  className="w-full h-64 bg-slate-900 text-slate-100 p-4 rounded border border-slate-600 focus:border-amber-400 focus:outline-none overflow-y-auto"
                  data-placeholder="Paste your formatted case here (highlights and bold preserved)..."
                />

                <div className="mt-4 space-y-4">
                  <div>
                    <label className="block text-slate-300 mb-2">
                      Speech Length: {speechLength} minutes
                    </label>
                    <input
                      type="range"
                      min="1"
                      max="8"
                      value={speechLength}
                      onChange={(e) => setSpeechLength(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between text-xs text-slate-400 mt-1">
                      <span>1 min</span>
                      <span>8 min</span>
                    </div>
                  </div>

                  <button
                    onClick={generateCounterSpeech}
                    disabled={loading}
                    className="w-full bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 text-slate-900 font-semibold py-3 rounded transition-colors flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <>
                        <div className="animate-spin h-5 w-5 border-2 border-slate-900 border-t-transparent rounded-full" />
                        Generating...
                      </>
                    ) : (
                      <>
                        <Volume2 size={20} />
                        Generate Counter-Speech
                      </>
                    )}
                  </button>
                </div>

                {parsedArgs.length > 0 && (
                  <div className="mt-4 p-3 bg-slate-900/50 rounded border border-slate-600">
                    <h3 className="text-sm font-semibold text-amber-400 mb-2">
                      Detected Arguments: {parsedArgs.length}
                    </h3>
                    <div className="space-y-2 text-xs text-slate-300">
                      {parsedArgs.map((arg, i) => (
                        <div key={i} className="border-l-2 border-amber-500 pl-2">
                          <div className="font-semibold">{arg.tag || `Argument ${i + 1}`}</div>
                          <div className="text-slate-400">{arg.author}</div>
                          <div className="text-slate-500 text-xs mt-1">
                            {arg.highlights.length} highlight{arg.highlights.length !== 1 ? 's' : ''} detected
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-semibold text-amber-400">
                    Counter-Speech
                  </h2>
                  {generatedSpeech && (
                    <div className="flex gap-2">
                      <button
                        onClick={copyToClipboard}
                        className="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                        title="Copy to clipboard"
                      >
                        <Copy size={18} className="text-slate-300" />
                      </button>
                      <button
                        onClick={downloadSpeech}
                        className="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                        title="Download"
                      >
                        <Download size={18} className="text-slate-300" />
                      </button>
                    </div>
                  )}
                </div>

                <div className="bg-slate-900 rounded p-4 h-96 overflow-y-auto border border-slate-600">
                  {generatedSpeech ? (
                    <p className="text-slate-100 whitespace-pre-wrap leading-relaxed">
                      {generatedSpeech}
                    </p>
                  ) : (
                    <p className="text-slate-400 italic">
                      Your generated counter-speech will appear here...
                    </p>
                  )}
                </div>
              </div>
            </div>

            <div className="mt-6 bg-slate-800/30 backdrop-blur rounded-lg p-4 border border-slate-700">
              <h3 className="text-lg font-semibold text-amber-400 mb-2">
                <FileText className="inline mr-2" size={20} />
                How to Use
              </h3>
              <div className="text-slate-300 text-sm space-y-2">
                <p><strong>Step 1:</strong> Copy your formatted debate case from your word processor</p>
                <p><strong>Step 2:</strong> Paste it directly into the input box - all formatting will be preserved!</p>
                <p><strong>Step 3:</strong> Hamilton will automatically detect highlighted text, bold tags, and author citations</p>
                <p><strong>Step 4:</strong> Adjust speech length and click generate!</p>
              </div>
            </div>
          </div>
        ) : (
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
              <h2 className="text-2xl font-semibold text-amber-400 mb-4">
                Case Parameters
              </h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-slate-300 mb-2 font-semibold">
                    Topic / Resolution
                  </label>
                  <input
                    type="text"
                    value={topic}
                    onChange={(e) => setTopic(e.target.value)}
                    placeholder="We should ban nuclear weapons"
                    className="w-full bg-slate-900 text-slate-100 p-3 rounded border border-slate-600 focus:border-amber-400 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-slate-300 mb-2 font-semibold">
                    Side
                  </label>
                  <div className="flex gap-4">
                    <button
                      onClick={() => setSide('Aff')}
                      className={`flex-1 py-2 rounded font-semibold transition-colors ${
                        side === 'Aff'
                          ? 'bg-amber-500 text-slate-900'
                          : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                      }`}
                    >
                      Affirmative
                    </button>
                    <button
                      onClick={() => setSide('Neg')}
                      className={`flex-1 py-2 rounded font-semibold transition-colors ${
                        side === 'Neg'
                          ? 'bg-amber-500 text-slate-900'
                          : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                      }`}
                    >
                      Negative
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-slate-300 mb-2 font-semibold">
                    Focus Point 1 <span className="text-xs text-slate-400">(Required)</span>
                  </label>
                  <input
                    type="text"
                    value={focusPoint1}
                    onChange={(e) => setFocusPoint1(e.target.value)}
                    placeholder="Economy, National Security, etc."
                    className="w-full bg-slate-900 text-slate-100 p-3 rounded border border-slate-600 focus:border-amber-400 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-slate-300 mb-2 font-semibold">
                    Focus Point 2 <span className="text-xs text-slate-400">(Optional)</span>
                  </label>
                  <input
                    type="text"
                    value={focusPoint2}
                    onChange={(e) => setFocusPoint2(e.target.value)}
                    placeholder="Indo-Pacific Relations, Climate, etc."
                    className="w-full bg-slate-900 text-slate-100 p-3 rounded border border-slate-600 focus:border-amber-400 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-slate-300 mb-2">
                    Evidence per Focus Point: {evidencePerPoint}
                  </label>
                  <input
                    type="range"
                    min="1"
                    max="5"
                    value={evidencePerPoint}
                    onChange={(e) => setEvidencePerPoint(parseInt(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-between text-xs text-slate-400 mt-1">
                    <span>1</span>
                    <span>5</span>
                  </div>
                </div>

                <button
                  onClick={generateCase}
                  disabled={caseLoading}
                  className="w-full bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 text-slate-900 font-semibold py-3 rounded transition-colors flex items-center justify-center gap-2"
                >
                  {caseLoading ? (
                    <>
                      <div className="animate-spin h-5 w-5 border-2 border-slate-900 border-t-transparent rounded-full" />
                      Generating Case...
                    </>
                  ) : (
                    <>
                      <FileText size={20} />
                      Generate Case
                    </>
                  )}
                </button>
              </div>
            </div>

            <div className="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-amber-400">
                  Generated Case
                </h2>
                {generatedCase && (
                  <div className="flex gap-2">
                    <button
                      onClick={copyCase}
                      className="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                      title="Copy to clipboard"
                    >
                      <Copy size={18} className="text-slate-300" />
                    </button>
                    <button
                      onClick={downloadCase}
                      className="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                      title="Download"
                    >
                      <Download size={18} className="text-slate-300" />
                    </button>
                  </div>
                )}
              </div>

              <div className="bg-slate-900 rounded p-4 h-96 overflow-y-auto border border-slate-600">
                {generatedCase ? (
                  <div 
                    className="text-slate-100 leading-relaxed"
                    dangerouslySetInnerHTML={{ __html: generatedCase }}
                  />
                ) : (
                  <p className="text-slate-400 italic">
                    Your generated debate case will appear here with properly formatted evidence, tags, and citations...
                  </p>
                )}
              </div>
            </div>
          </div>
        )}
      </div>

      <style>{`
        [contenteditable]:empty:before {
          content: attr(data-placeholder);
          color: #94a3b8;
          font-style: italic;
        }
        [contenteditable] mark,
        [contenteditable] em {
          background-color: yellow;
          color: black;
        }
        mark {
          background-color: yellow;
          color: black;
        }
        strong {
          font-weight: bold;
          color: #fbbf24;
        }
      `}</style>
    </div>
  );
};

export default HamiltonDebate;
