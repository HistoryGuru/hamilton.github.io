<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamilton - Debate Speech Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
            font-style: italic;
        }
        [contenteditable] mark,
        [contenteditable] em {
            background-color: yellow;
            color: black;
        }
        .tab-active {
            background-color: rgb(251, 191, 36);
            color: rgb(15, 23, 42);
        }
        .tab-inactive {
            background-color: rgb(51, 65, 85);
            color: rgb(203, 213, 225);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-bold text-amber-400 mb-2 tracking-tight">Hamilton</h1>
            <p class="text-slate-300 text-lg">Intelligent Debate Tool Suite</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6">
            <button id="tabRebuttal" class="tab-active px-6 py-3 rounded-t-lg font-semibold transition-colors">
                Counter-Speech Generator
            </button>
            <button id="tabCaseWriter" class="tab-inactive px-6 py-3 rounded-t-lg font-semibold transition-colors">
                Write Me a Case
            </button>
        </div>

        <!-- Rebuttal Tab Content -->
        <div id="rebuttalContent" class="tab-content">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Input Section -->
                <div class="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
                    <h2 class="text-2xl font-semibold text-amber-400 mb-4">Case Input</h2>
                    
                    <div
                        id="caseInput"
                        contenteditable="true"
                        class="w-full h-64 bg-slate-900 text-slate-100 p-4 rounded border border-slate-600 focus:border-amber-400 focus:outline-none overflow-y-auto"
                        data-placeholder="Paste your formatted case here (highlights and bold preserved)..."
                    ></div>

                    <div class="mt-4 space-y-4">
                        <div>
                            <label class="block text-slate-300 mb-2">
                                Speech Length: <span id="speechLengthDisplay">3</span> minutes
                            </label>
                            <input
                                type="range"
                                id="speechLength"
                                min="1"
                                max="8"
                                value="3"
                                class="w-full"
                            />
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>1 min</span>
                                <span>8 min</span>
                            </div>
                        </div>

                        <button
                            id="generateBtn"
                            class="w-full bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 text-slate-900 font-semibold py-3 rounded transition-colors flex items-center justify-center gap-2"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                            Generate Counter-Speech
                        </button>
                    </div>

                    <div id="parsedArgsDisplay" class="mt-4 hidden p-3 bg-slate-900/50 rounded border border-slate-600">
                        <h3 class="text-sm font-semibold text-amber-400 mb-2">Detected Arguments: <span id="argCount">0</span></h3>
                        <div id="argsList" class="space-y-2 text-xs text-slate-300"></div>
                    </div>
                </div>

                <!-- Output Section -->
                <div class="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-amber-400">Counter-Speech</h2>
                        <div class="flex gap-2">
                            <button
                                id="copyBtn"
                                class="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                title="Copy to clipboard"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button
                                id="downloadBtn"
                                class="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                title="Download"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="outputBox" class="bg-slate-900 rounded p-4 h-96 overflow-y-auto border border-slate-600">
                        <p class="text-slate-400 italic">Your generated counter-speech will appear here...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Case Writer Tab Content -->
        <div id="caseWriterContent" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Input Section -->
                <div class="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
                    <h2 class="text-2xl font-semibold text-amber-400 mb-4">Case Parameters</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-slate-300 mb-2">Resolution/Topic</label>
                            <input
                                type="text"
                                id="caseTopic"
                                placeholder="e.g., We should increase military presence in the Indo-Pacific"
                                class="w-full bg-slate-900 text-slate-100 p-3 rounded border border-slate-600 focus:border-amber-400 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Side</label>
                            <div class="flex gap-3">
                                <button id="sideAff" class="flex-1 py-2 rounded bg-slate-700 hover:bg-amber-500 hover:text-slate-900 text-slate-300 transition-colors">
                                    Affirmative
                                </button>
                                <button id="sideNeg" class="flex-1 py-2 rounded bg-slate-700 hover:bg-amber-500 hover:text-slate-900 text-slate-300 transition-colors">
                                    Negative
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Focus Point 1</label>
                            <input
                                type="text"
                                id="focusPoint1"
                                placeholder="e.g., Economy, National Security"
                                class="w-full bg-slate-900 text-slate-100 p-3 rounded border border-slate-600 focus:border-amber-400 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Focus Point 2 (Optional)</label>
                            <input
                                type="text"
                                id="focusPoint2"
                                placeholder="e.g., Indo-Pacific Relations"
                                class="w-full bg-slate-900 text-slate-100 p-3 rounded border border-slate-600 focus:border-amber-400 focus:outline-none"
                            />
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">
                                Evidence per Focus Point: <span id="evidenceCountDisplay">3</span>
                            </label>
                            <input
                                type="range"
                                id="evidenceCount"
                                min="1"
                                max="5"
                                value="3"
                                class="w-full"
                            />
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>1</span>
                                <span>5</span>
                            </div>
                        </div>

                        <button
                            id="generateCaseBtn"
                            class="w-full bg-amber-500 hover:bg-amber-600 disabled:bg-slate-600 text-slate-900 font-semibold py-3 rounded transition-colors flex items-center justify-center gap-2"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Generate Case
                        </button>
                    </div>
                </div>

                <!-- Output Section -->
                <div class="bg-slate-800/50 backdrop-blur rounded-lg p-6 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-amber-400">Generated Case</h2>
                        <div class="flex gap-2">
                            <button
                                id="copyCaseBtn"
                                class="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                title="Copy to clipboard"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button
                                id="downloadCaseBtn"
                                class="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                title="Download"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="caseOutputBox" class="bg-slate-900 rounded p-4 h-96 overflow-y-auto border border-slate-600">
                        <p class="text-slate-400 italic">Your generated case will appear here...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-6 bg-slate-800/30 backdrop-blur rounded-lg p-4 border border-slate-700">
            <h3 class="text-lg font-semibold text-amber-400 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                Instructions
            </h3>
            <div id="instructions" class="text-slate-300 text-sm space-y-2">
                <p><strong>Counter-Speech Generator:</strong> Paste opponent's case with formatting preserved, adjust length, and generate rebuttals.</p>
                <p><strong>Case Writer:</strong> Enter your resolution, choose side, specify focus points, and generate a complete case with evidence.</p>
            </div>
        </div>
    </div>

    <script>
        let puterReady = false;
        let generatedSpeech = '';
        let generatedCase = '';
        let selectedSide = '';

        // Wait for Puter to load
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.puter && window.puter.ai) {
                    puterReady = true;
                    console.log('Puter AI ready');
                } else {
                    console.warn('Puter AI not available');
                }
            }, 1000);
        });

        // Tab switching
        document.getElementById('tabRebuttal').addEventListener('click', () => {
            document.getElementById('tabRebuttal').className = 'tab-active px-6 py-3 rounded-t-lg font-semibold transition-colors';
            document.getElementById('tabCaseWriter').className = 'tab-inactive px-6 py-3 rounded-t-lg font-semibold transition-colors';
            document.getElementById('rebuttalContent').classList.remove('hidden');
            document.getElementById('caseWriterContent').classList.add('hidden');
        });

        document.getElementById('tabCaseWriter').addEventListener('click', () => {
            document.getElementById('tabCaseWriter').className = 'tab-active px-6 py-3 rounded-t-lg font-semibold transition-colors';
            document.getElementById('tabRebuttal').className = 'tab-inactive px-6 py-3 rounded-t-lg font-semibold transition-colors';
            document.getElementById('caseWriterContent').classList.remove('hidden');
            document.getElementById('rebuttalContent').classList.add('hidden');
        });

        // Side selection
        document.getElementById('sideAff').addEventListener('click', function() {
            selectedSide = 'Affirmative';
            this.classList.add('bg-amber-500', 'text-slate-900');
            this.classList.remove('bg-slate-700', 'text-slate-300');
            document.getElementById('sideNeg').classList.remove('bg-amber-500', 'text-slate-900');
            document.getElementById('sideNeg').classList.add('bg-slate-700', 'text-slate-300');
        });

        document.getElementById('sideNeg').addEventListener('click', function() {
            selectedSide = 'Negative';
            this.classList.add('bg-amber-500', 'text-slate-900');
            this.classList.remove('bg-slate-700', 'text-slate-300');
            document.getElementById('sideAff').classList.remove('bg-amber-500', 'text-slate-900');
            document.getElementById('sideAff').classList.add('bg-slate-700', 'text-slate-300');
        });

        // Update displays
        document.getElementById('speechLength').addEventListener('input', (e) => {
            document.getElementById('speechLengthDisplay').textContent = e.target.value;
        });

        document.getElementById('evidenceCount').addEventListener('input', (e) => {
            document.getElementById('evidenceCountDisplay').textContent = e.target.value;
        });

        // Parse case function (from original)
        function parseRichTextCase(htmlContent) {
            const args = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const body = doc.body;

            const highlightedElements = [];
            const walker = document.createTreeWalker(body, NodeFilter.SHOW_ELEMENT, null, false);

            let node;
            while (node = walker.nextNode()) {
                const style = window.getComputedStyle(node);
                const bgColor = style.backgroundColor || node.style.backgroundColor;
                
                const hasBackground = bgColor && 
                    bgColor !== 'transparent' && 
                    bgColor !== 'rgba(0, 0, 0, 0)' &&
                    bgColor !== 'rgb(255, 255, 255)' &&
                    bgColor !== '#ffffff' &&
                    bgColor !== 'white';
                
                const isHighlighted = 
                    node.tagName === 'MARK' ||
                    node.tagName === 'EM' ||
                    hasBackground ||
                    node.style.textDecoration?.includes('underline');

                if (isHighlighted) {
                    const text = node.textContent.trim();
                    if (text.length > 10) {
                        highlightedElements.push(text);
                    }
                }
            }

            const fullText = body.textContent;
            const lines = fullText.split('\n').map(l => l.trim()).filter(l => l);

            let currentArg = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                const authorMatch = line.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+[''](\d{2}|\d{4})/);
                if (authorMatch) {
                    if (currentArg && currentArg.highlights.length > 0) {
                        args.push(currentArg);
                    }
                    currentArg = {
                        author: authorMatch[0],
                        tag: '',
                        highlights: []
                    };
                    continue;
                }

                if (currentArg && !currentArg.tag) {
                    const tagMatch = line.match(/^\[([^\]]+)\]/) || line.match(/^([A-Z\s]{5,}[A-Z])$/);
                    if (tagMatch) {
                        currentArg.tag = tagMatch[1] || tagMatch[0];
                        continue;
                    }
                }
            }

            if (highlightedElements.length > 0) {
                if (currentArg) {
                    currentArg.highlights = highlightedElements;
                    args.push(currentArg);
                } else {
                    const authorMatch = fullText.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+[''](\d{2}|\d{4})/);
                    args.push({
                        author: authorMatch ? authorMatch[0] : 'Source citation',
                        tag: lines[0]?.substring(0, 100) || 'Main argument',
                        highlights: highlightedElements
                    });
                }
            }

            return args;
        }

        // Display parsed arguments
        function displayParsedArgs(args) {
            const display = document.getElementById('parsedArgsDisplay');
            const count = document.getElementById('argCount');
            const list = document.getElementById('argsList');

            if (args.length === 0) {
                display.classList.add('hidden');
                return;
            }

            count.textContent = args.length;
            list.innerHTML = args.map((arg, i) => `
                <div class="border-l-2 border-amber-500 pl-2">
                    <div class="font-semibold">${arg.tag || `Argument ${i + 1}`}</div>
                    <div class="text-slate-400">${arg.author}</div>
                    <div class="text-slate-500 text-xs mt-1">
                        ${arg.highlights.length} highlight${arg.highlights.length !== 1 ? 's' : ''} detected
                    </div>
                </div>
            `).join('');
            display.classList.remove('hidden');
        }

        // Generate counter-speech
        async function generateCounterSpeech() {
            const btn = document.getElementById('generateBtn');
            const outputBox = document.getElementById('outputBox');
            const caseInput = document.getElementById('caseInput');
            const speechLength = document.getElementById('speechLength').value;

            btn.disabled = true;
            btn.innerHTML = `
                <div class="animate-spin h-5 w-5 border-2 border-slate-900 border-t-transparent rounded-full"></div>
                Generating...
            `;

            const htmlContent = caseInput.innerHTML;
            const parsed = parseRichTextCase(htmlContent);
            displayParsedArgs(parsed);

            if (parsed.length === 0) {
                outputBox.innerHTML = `<p class="text-slate-100">No arguments detected. Please ensure your case includes:<br>- Author citations (e.g., Smith '23)<br>- Bolded tags<br>- Highlighted evidence (use your word processor's highlight tool, then copy/paste)</p>`;
                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                    Generate Counter-Speech
                `;
                return;
            }

            if (!window.puter || !window.puter.ai) {
                outputBox.innerHTML = `<p class="text-slate-100">Puter AI is not available. Please refresh the page and try again.</p>`;
                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                    Generate Counter-Speech
                `;
                return;
            }

            try {
                const prompt = `You are a skilled debate coach. Generate a ${speechLength}-minute rebuttal speech against the following arguments. Be direct, analytical, and persuasive. Structure your speech with clear transitions.

Arguments to refute:
${parsed.map((arg, i) => `
${i + 1}. ${arg.tag || 'Argument'}
Source: ${arg.author}
Key claims: ${arg.highlights.join(' ... ')}
`).join('\n')}

Generate a flowing ${speechLength}-minute speech that:
1. Briefly signposts the main refutations
2. Systematically addresses each argument with specific counterarguments
3. Points out logical flaws, questionable evidence, or alternative interpretations
4. Uses clear transitions between points
5. Concludes with impact analysis

Format as a natural speech, not bullet points. Target approximately ${speechLength * 150} words.`;

                const response = await window.puter.ai.chat(prompt, { model: "gpt-4o-mini" });
                generatedSpeech = response;
                outputBox.innerHTML = `<p class="text-slate-100 whitespace-pre-wrap leading-relaxed">${response}</p>`;
            } catch (error) {
                console.error('Error:', error);
                outputBox.innerHTML = `<p class="text-slate-100">Error generating speech. Please try again.<br><br>Error: ${error.message}</p>`;
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
                Generate Counter-Speech
            `;
        }

        <script src="https://js.puter.com/v2/"></script>

<section id="case-writer" style="padding: 20px; border: 1px solid #ccc; margin-top: 20px; font-family: 'Times New Roman', serif;">
    <h2>Write Me A Case (Powered by AI)</h2>
    
    <div class="input-group" style="margin-bottom: 10px;">
        <label>Topic: </label>
        <input type="text" id="topicInput" placeholder="We should increase..." style="width: 300px;">
    </div>

    <div class="input-group" style="margin-bottom: 10px;">
        <label>Side: </label>
        <select id="sideInput">
            <option value="Aff">Affirmative</option>
            <option value="Neg">Negative</option>
        </select>
    </div>

    <div class="input-group" style="margin-bottom: 10px;">
        <label>Focus Point 1: </label>
        <input type="text" id="focus1Input" placeholder="Economy">
    </div>

    <div class="input-group" style="margin-bottom: 10px;">
        <label>Focus Point 2 (Optional): </label>
        <input type="text" id="focus2Input" placeholder="Indo Pacific Relations">
    </div>

    <div class="input-group" style="margin-bottom: 10px;">
        <label>Amount of Evidence (1-5): </label>
        <input type="number" id="evidenceCount" min="1" max="5" value="1">
    </div>

    <button id="genBtn" onclick="generateCase()" style="padding: 10px 20px; cursor: pointer; background-color: #333; color: white; border: none;">Generate Case</button>

    <hr>

    <div id="caseOutput" style="margin-top: 20px;"></div>
</section>

<script>
    async function generateCase() {
        const topic = document.getElementById('topicInput').value;
        const side = document.getElementById('sideInput').value;
        const focus1 = document.getElementById('focus1Input').value;
        const focus2 = document.getElementById('focus2Input').value;
        const count = parseInt(document.getElementById('evidenceCount').value);
        const outputDiv = document.getElementById('caseOutput');
        const btn = document.getElementById('genBtn');

        // Validation
        if (!topic || !focus1) {
            alert("Please enter a Topic and at least Focus Point 1.");
            return;
        }

        // UI Loading State
        outputDiv.innerHTML = "<em>Generating case... this may take a few seconds...</em>";
        btn.disabled = true;
        btn.innerText = "Generating...";

        const focusPoints = [focus1];
        if (focus2) focusPoints.push(focus2);

        try {
            // Loop through each focus point (doing them sequentially to handle API load)
            outputDiv.innerHTML = ""; // Clear loading text
            
            for (const focus of focusPoints) {
                // Create Header
                const focusHeader = document.createElement("h3");
                focusHeader.innerText = `Contention: ${focus}`;
                focusHeader.style.textDecoration = "underline";
                outputDiv.appendChild(focusHeader);

                // Construct the Prompt for the AI
                const prompt = `
                    You are a debate case writer.
                    Topic: "${topic}"
                    Side: ${side}
                    Focus Point: "${focus}"
                    
                    Generate ${count} distinct pieces of evidence (cards).
                    
                    STRICT LOGIC:
                    For each card, follow this logic chain:
                    1. Claim: A statement connecting the ${side} to the ${focus}.
                    2. Link: How the specific legislation or action causes this.
                    3. Impact: The ultimate good/bad result (e.g. War, Economic Collapse).

                    OUTPUT FORMAT:
                    Return ONLY a raw JSON array. Do not include markdown formatting like \`\`\`json.
                    The array must contain objects with these keys:
                    - "tag": The main point (Claim + Impact) formatted as a summary sentence.
                    - "citation": A fake author and year (e.g., "Smith '24").
                    - "body": A paragraph (~60 words) simulating an article. You MUST use HTML tags <u><mark> inside this string to highlight the Claim, Link, and Impact sentences. The rest of the text should be normal.
                `;

                // Call Puter AI
                // Note: puter.ai.chat returns a response object. We force it to text for parsing.
                const response = await puter.ai.chat(prompt);
                
                // Parse the response (Cleaning up potential markdown wrappers)
                let cleanJson = response.toString().replace(/```json/g, '').replace(/```/g, '').trim();
                let cards = [];
                try {
                    cards = JSON.parse(cleanJson);
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    outputDiv.innerHTML += `<p style="color:red">Error parsing AI response. Try again.</p>`;
                    continue;
                }

                // Render Cards
                cards.forEach(card => {
                    const cardDiv = document.createElement("div");
                    cardDiv.style.marginBottom = "30px";
                    cardDiv.style.borderBottom = "1px solid #eee";
                    cardDiv.style.paddingBottom = "15px";

                    // 1. TAG
                    const tag = document.createElement("div");
                    tag.style.fontWeight = "bold";
                    tag.style.fontSize = "1.1em";
                    tag.style.marginBottom = "5px";
                    tag.innerText = card.tag;
                    cardDiv.appendChild(tag);

                    // 2. CITATION
                    const author = document.createElement("div");
                    author.style.fontWeight = "bold";
                    author.style.marginBottom = "5px";
                    author.innerText = card.citation;
                    cardDiv.appendChild(author);

                    // 3. BODY (With HTML highlighting)
                    const bodyText = document.createElement("div");
                    bodyText.style.fontSize = "0.9em";
                    bodyText.style.lineHeight = "1.4";
                    bodyText.innerHTML = card.body; // Injecting the HTML <u><mark> tags
                    cardDiv.appendChild(bodyText);

                    outputDiv.appendChild(cardDiv);
                });
            }

        } catch (error) {
            console.error(error);
            outputDiv.innerHTML = `<p style="color:red">An error occurred: ${error.message}</p>`;
        } finally {
            // Reset Button
            btn.disabled = false;
            btn.innerText = "Generate Case";
        }
    }
</script>
